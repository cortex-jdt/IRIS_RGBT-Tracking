% Auto-generated by cameraCalibrator app on 04-Jul-2025
% Modified to save all parameters to a single YAML file using the correct
% parameter extraction methods as specified by the user.
%-------------------------------------------------------
clear;
clc;
close all;

% --- USER CONFIGURATION ---

% 1. Define images to process
% v4_Calib_100725
imageFileNames = {'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_135821_412541563.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_135835_851840047.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_135849_024874296.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_135852_391954347.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_135855_759201148.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_135901_626969478.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_135920_600581823.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_135932_605437095.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_135942_210173583.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_135948_245482384.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_135958_616606044.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140003_185834797.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140015_757192859.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140029_102408100.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140033_935505237.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140048_474794749.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140054_140902351.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140111_183344517.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140116_584678616.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140121_623836227.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140136_593872928.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140140_533074763.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140143_132280274.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140150_303705047.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140153_538468973.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140157_804447409.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140208_378247771.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140211_709765590.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140215_280076505.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140218_649427289.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140225_416604385.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140230_183740971.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140404_515945666.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140408_119105324.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140411_816425984.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140415_919607211.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140420_287839240.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140424_956613559.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140426_992964616.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140434_997325183.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140441_597808352.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140547_596118936.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140553_066347795.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140555_435771517.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140601_002586970.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140604_638977594.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140609_502227324.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140618_544304848.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140634_452660020.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140639_119949456.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140643_722167221.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140648_823360400.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140803_396217124.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_140820_870196814.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_141004_225603356.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_141008_228006570.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_141011_728604712.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_141843_431955004.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_141850_634867266.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_141855_734849865.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_141858_801711608.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_141902_641104975.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_141906_110422142.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142016_596830626.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142025_232699478.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142030_633194217.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142035_701317319.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142043_504285558.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142048_274131978.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142053_575274685.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142057_109530437.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142059_647793066.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142105_148093546.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142127_826956961.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142133_329734191.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142136_997891634.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142140_297365140.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142143_432220065.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142146_032359066.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142152_035103691.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142155_104252834.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142157_805432219.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142200_341727941.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142202_671657577.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142216_511497674.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142219_348335103.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142221_514430490.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142224_351934438.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142241_154325780.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142243_426977017.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142246_293718981.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142250_658887133.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142255_896691314.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142258_397615271.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142300_302670240.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142302_802176164.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142304_966589490.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142306_834708459.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142308_672784578.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142315_237621166.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142320_004244480.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142321_741976258.png',...
    'C:\Main Storage\ITB OneDrive\IRIS NUS\Dataset\Calibration\v4_Calib_100725\left_thermal\thermal_inferno_image_20250710_142323_643798110.png',...
    };

% 2. Define the output YAML filename and camera name
yamlFile = 'LeftCam_parameters.yaml'; % v2_Calib_020725
% yamlFile = 'LeftInferno_v5_CalibNew_parameters.yaml'; % v5_CalibNew
cameraName = 'Left Thermal Camera'; % This will be the header in the YAML file

% --- END OF USER CONFIGURATION ---


% Detect calibration pattern in images
detector = vision.calibration.monocular.AsymmetricCircleGridDetector();
patternDims = [4, 11];
circleColor = "white";
[imagePoints, imagesUsed] = detectPatternPoints(detector, imageFileNames, 'PatternDims', patternDims, 'CircleColor', circleColor);
imageFileNames = imageFileNames(imagesUsed);

% Read the first image to obtain image size
originalImage = imread(imageFileNames{1});
[mrows, ncols, ~] = size(originalImage);

% Generate world coordinates for the planar pattern keypoints
centerDistance = 12.000000;  % in centimeters
worldPoints = generateWorldPoints(detector, 'PatternDims', patternDims, 'CenterDistance', centerDistance);

% Calibrate the camera
% Generate new intrinsic params & distortion too
[cameraParams, imagesUsed, estimationErrors] = estimateCameraParameters(imagePoints, worldPoints, ...
    'EstimateSkew', false, 'EstimateTangentialDistortion', true, ...
    'NumRadialDistortionCoefficients', 2, 'WorldUnits', 'centimeters', ...
    'ImageSize', [mrows, ncols]);

% View reprojection errors
h1=figure; showReprojectionErrors(cameraParams);

% Visualize pattern locations
h2=figure; showExtrinsics(cameraParams, 'CameraCentric');

% Display parameter estimation errors
displayErrors(estimationErrors, cameraParams);


% --- MODIFIED SECTION: Extract and Save All Parameters to YAML File ---
disp(['Writing results to ', yamlFile, '...']);
fid = fopen(yamlFile, 'w');

% Extract intrinsic parameters from the final calibrated object
K = cameraParams.K;
fx = K(1,1); fy = K(2,2);
cx = K(1,3); cy = K(2,3);
k1 = cameraParams.RadialDistortion(1);
k2 = cameraParams.RadialDistortion(2);
% Since we set EstimateTangentialDistortion to false, p1 and p2 are 0
p1 = 0; p2 = 0;

% Write intrinsic parameters
fprintf(fid, "%s\n", cameraName);
fprintf(fid, "intrinsic:\n");
fprintf(fid, "  fx: %.8f\n  fy: %.8f\n  cx: %.8f\n  cy: %.8f\n", fx, fy, cx, cy);
fprintf(fid, "  k1: %.8f\n  k2: %.8f\n  p1: %.8f\n  p2: %.8f\n", k1, k2, p1, p2);

% Write extrinsic parameters for each image
fprintf(fid, "extrinsics:\n");
for i = 1:numel(imageFileNames)
    % --- FIX: Use the correct properties as identified by the user ---
    R = cameraParams.PatternExtrinsics(i,1).R;
    t = cameraParams.PatternExtrinsics(i,1).Translation;
    
    % --- FIX: Calculate per-image RMS reprojection error from the raw error data ---
    errors = cameraParams.ReprojectionErrors(:, :, i);
    rmsError = sqrt(mean(sum(errors.^2, 2)));
    
    % Write to file
    [~, name, ext] = fileparts(imageFileNames{i});
    fprintf(fid, "  - image: %s%s\n", name, ext);
    fprintf(fid, "    rotation:\n");
    for r = 1:3
        fprintf(fid, "      - [%.8f, %.8f, %.8f]\n", R(r,1), R(r,2), R(r,3));
    end
    fprintf(fid, "    translation: [%.8f, %.8f, %.8f]\n", t(1), t(2), t(3));
    fprintf(fid, "    rms_error: %.6f\n", rmsError);
end

fclose(fid);
disp(['✅ YAML file with all parameters written to ', yamlFile]);
% --- END OF MODIFIED SECTION ---
